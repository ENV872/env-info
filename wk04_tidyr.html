<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="Ben Best" />


<title>Week 4: Wrangling Data II</title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.1/css/cosmo.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.1/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/respond.min.js"></script>

<!-- http://www.favicon-generator.org/ -->
<link rel="apple-touch-icon" sizes="57x57" href="favicons/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="favicons/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="favicons/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="favicons/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="favicons/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="favicons/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="favicons/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="favicons/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="favicons/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="favicons/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="favicons/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicons/favicon-16x16.png">
<link rel="manifest" href="favicons/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="../favicons/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">

<link rel="shortcut icon" type="image/x-icon" href="favicon.ico">

<link href="libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet">
<script src="libs/tocify-1.9.1/jquery-ui-1.9.2.custom.min.js"></script>
<script src="libs/tocify-1.9.1/jquery.tocify.min.js"></script>

<link href="libs/lightbox-2.8.2/css/lightbox.min.css" rel="stylesheet">

<!--
Font Awesome: http://fortawesome.github.io/Font-Awesome/icons
Octicons:     https://octicons.github.com
-->
<link rel="stylesheet" href="libs/font-awesome-4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="libs/octicons-3.3.0/octicons.css">

<style type="text/css">
@media (max-width: 992px) {
#toc {
  position: relative;
  width: 100%;
  margin: 0px 0px 20px 0px;
}
}
</style>

<style type="text/css">code{white-space: pre;}</style>
<link rel="stylesheet"
      href="libs/highlight/textmate.css"
      type="text/css" />
<script src="libs/highlight/highlight.js"></script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>


<link rel="stylesheet" href="libs/font-awesome-4.5.0/css/font-awesome.min.css" type="text/css" />
<link rel="stylesheet" href="libs/octicons-3.3.0/octicons.css" type="text/css" />
<link rel="stylesheet" href="styles/styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>
<div class="container-fluid main-container">

<!--- https://codepo8.github.io/css-fork-on-github-ribbon/ 
<style>#forkongithub a{background:#000;color:#fff;text-decoration:none;font-family:arial,sans-serif;text-align:center;font-weight:bold;padding:5px 40px;font-size:1rem;line-height:2rem;position:relative;transition:0.5s;}#forkongithub a:hover{background:#c11;color:#fff;}#forkongithub a::before,#forkongithub a::after{content:"";width:100%;display:block;position:absolute;top:1px;left:0;height:1px;background:#fff;}#forkongithub a::after{bottom:1px;top:auto;}@media screen and (min-width:800px){#forkongithub{position:fixed;display:block;top:0;left:0;width:200px;overflow:hidden;height:200px;z-index:9999;}#forkongithub a{width:200px;position:absolute;top:60px;left:-60px;transform:rotate(-45deg);-webkit-transform:rotate(-45deg);-ms-transform:rotate(-45deg);-moz-transform:rotate(-45deg);-o-transform:rotate(-45deg);box-shadow:4px 4px 10px rgba(0,0,0,0.8);}}</style><span id="forkongithub"><a href="https://github.com/ucsb-bren/env-info">Fork me on GitHub</a></span>
-->
<div class="row-fluid">
<div class="navbar navbar-default navbar-fixed-top navbar-transparent">
  <div class="container">
    <div class="navbar-header">
      <a href="http://ucsb-bren.github.io/env-info/" class="navbar-brand"><i class="fa fa-home"></i> env-info</a>
      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <div class="navbar-collapse collapse" id="navbar-main">
      <!--
      <ul class="nav navbar-nav">
        <li>
          <a href="/#schedule"><i class="fa fa-calendar"></i> schedule</a>
        </li>
      </ul>
      -->
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/students"><i class="fa fa-users"></i> students</a></li>
      </ul>
    </div>
  </div>
</div>
</div>

<div class="row-fluid">
  <div class="span3 col-md-3">
    <div id="toc"></div>
  </div>
  <div class="main-content span9 col-md-9">

<div id="header">
<h1 class="title">Week 4: Wrangling Data II</h1>
<h4 class="author"><em>Ben Best</em></h4>
<h4 class="date"><em>2016-01-26 16:23</em></h4>
</div>


<div id="schedule" class="section level2">
<h2>Schedule</h2>
<ul>
<li><p>8:30 - 9:15 [BB] <strong>demo</strong> functions from dplyr, tidyr, lubridate, and stringr libraries by walking through examples all together</p></li>
<li><p>9:15 - 9:45 [BB] <strong>individual</strong> exercises answering questions from datasets on <a href="http://edgar.jrc.ec.europa.eu/overview.php?v=CO2ts1990-2014&amp;sort=des9">CO2 emissions by country 1970-2014</a></p></li>
<li><p>9:45 - 10:00 <strong>break</strong></p></li>
<li><p>10:00 - 10:30 [BB] <strong>group</strong> work asking questions and answering them with your own datasets</p></li>
<li><p>10:30 - 11:30 [NT] <strong>programming concepts</strong></p></li>
</ul>
</div>
<div id="precursors" class="section level2">
<h2>Precursors</h2>
<div id="invitations" class="section level3">
<h3>Invitations</h3>
<ul>
<li><strong>organizations</strong>: invite <span class="citation">@bbest</span> and <span class="citation">@ctague</span> to your <a href="https://github.com/" class="uri">https://github.com/</a><organization> so we can directly <em>push</em> to your site (vs <em>fork</em> &amp; <em>pull request</em>)</li>
<li><strong>auditors</strong>: add to GauchoSpace to use announcements there</li>
</ul>
</div>
</div>
<div id="materials" class="section level2">
<h2>Materials</h2>
<ul>
<li><a href="https://stat545-ubc.github.io/">stat545-ubc: Data wrangling, exploration, and analysis with R</a></li>
</ul>
</div>
<div id="demo" class="section level2">
<h2>Demo</h2>
<p>nycflights13</p>
<pre class="r"><code>library(dplyr)
library(nycflights13)

# Convert data to a tbl_df so that it uses dplyr&#39;s nice print method
flights &lt;- tbl_df(flights)
flights

# Use glimpse to few some values in each column
glimpse(flights)

# filter: inspect subsets of data
# How many flights flew to Madison in 2013?
flights %&gt;%
  filter(dest == &quot;MSN&quot;)

# filter: multiple conditions
# How many flights flew to Madison in first week of January?
# Comma separated conditions are combined with &#39;&amp;&#39;
flights %&gt;%
  filter(dest == &quot;MSN&quot;, month == 1, day &lt;= 7)

# QuestionCommas in the filter statement are implicit &amp; (and) operators. Is there anything similar for | (or)?
# Logical or statements are supported, but there&#39;s no shorthand.
flights %&gt;%
  filter(dest == &quot;MSN&quot; | dest == &quot;ORD&quot; | dest == &quot;MDW&quot;)
# For more complicated checks, I would try a set operation.
flights %&gt;%
  filter(dest %in% c(&quot;MSN&quot;, &quot;ORD&quot;, &quot;MDW&quot;))


# arrange: sort columns
# Sort by which airport they departed from in NYC, then year, month, day.
flights %&gt;%
  arrange(origin, year, month, day)

# desc: reverses sorting of a column
# Find longest delayed flights to Madison.
flights %&gt;%
  filter(dest == &quot;MSN&quot;) %&gt;%
  arrange(desc(dep_delay))

# select
# Select the columns you want.
flights %&gt;%
  select(origin, year, month, day)

# select&#39;s helpers
# select has many helper functions. See ?select.
flights %&gt;%
  select(origin, year:day, starts_with(&quot;dep&quot;))

# negative selecting
# We can drop columns by “negating” the name. Since helpers give us column names, we can negate them too.
flights %&gt;%
  select(-dest, -starts_with(&quot;arr&quot;),
         -ends_with(&quot;time&quot;))</code></pre>
<p>Recap: Verbs for inspecting data:</p>
<ul>
<li>convert to a <code>tbl_df</code> - nice print method</li>
<li><code>glimpse</code> - some of each column</li>
<li><code>filter</code> - subsetting</li>
<li><code>arrange</code> - sorting (desc to reverse the sort)</li>
<li><code>select</code> - picking (and omiting) columns</li>
</ul>
<pre class="r"><code># rename
# Rename columns with rename(NewName = OldName). To keep the order correct, read/remember the renaming = as “was”.
flights %&gt;%
  rename(y = year, m = month, d = day)

# mutate
# How much departure delay did the flight make up for in the air?
flights %&gt;%
  mutate(
    gain = arr_delay - dep_delay,
    speed = (distance / air_time) * 60,
    gain_per_hour = gain / (air_time / 60)) %&gt;%
  select(gain:gain_per_hour)

# group_by
# Let&#39;s compute the average delay per month of flights to Madison.
# Normally–in aggregate, by or plyr&#39;s d*ply functions–you specify the grouping as an argument to the aggregation function.
aggregate(dep_delay ~ month, flights, mean,
          subset = flights$dest == &quot;MSN&quot;)

# group_by
# In dplyr, grouping is its own action. It is done as its own step in the pipeline. Here, we filter to the flights to Madison and group_by month.
msn_by_month &lt;- flights %&gt;%
  filter(dest == &quot;MSN&quot;) %&gt;%
  group_by(month)
msn_by_month

# summarise
# Now we use summarise to compute (several) aggregate values within each group (month). summarise returns one row per group.
msn_by_month %&gt;%
  summarise(
    flights = n(),
    avg_delay = mean(dep_delay, na.rm = TRUE),
    n_planes = n_distinct(tailnum))

# tally
# tally is a shortcut for counting number of items per group.
# Number of flights from NYC by destination by month:
flights %&gt;%
  group_by(dest, month) %&gt;%
  tally

# ungroup
# Remove the grouping structure with ungroup.
msn_by_month %&gt;% ungroup

# Summarizing undoes grouping.
# Each summarise statement peels off one layer of grouping (from the right of the list of groups).
# day gets peeled off
per_day &lt;- flights %&gt;%
  group_by(dest, year, month, day) %&gt;%
  summarise(flights = n())
per_day

# Peel off month grouping
per_month &lt;- per_day %&gt;%
  summarise(flights = sum(flights))
per_month</code></pre>
<p>That covers 80% of dplyr:</p>
<ul>
<li><code>select</code></li>
<li><code>filter</code></li>
<li><code>arrange</code></li>
<li><code>glimpse</code></li>
<li><code>rename</code></li>
<li><code>mutate</code></li>
<li><code>group_by</code>, <code>ungroup</code></li>
<li><code>summarise</code></li>
</ul>
<p>Other 20%</p>
<ul>
<li>assembly: <code>bind_rows</code>, <code>bind_cols</code></li>
<li>column-wise operations: <code>mutate_each</code>, <code>summarise_each</code></li>
<li>join tables together: <code>left_join</code>, <code>right_join</code>, <code>inner_join</code>, <code>full_join</code></li>
<li>filtering joins: <code>semi_join</code>, `anti_join</li>
<li><code>do</code>: arbitrary code on each chunk</li>
<li>different types of tabular data (databases, data.tables)</li>
</ul>
<div id="tidyr" class="section level3">
<h3>tidyr</h3>
<ul>
<li>what is an observation? wide vs long format</li>
</ul>
</div>
<div id="dplyr" class="section level3">
<h3>dplyr</h3>
<ul>
<li><p>group_by</p></li>
<li><p>mutate</p></li>
<li><p>join, inner, outer, anti. vs merge. relational database.</p></li>
<li><p>middleware abstraction. try with sqlite as relational db.</p></li>
</ul>
</div>
</div>
<div id="assignment" class="section level2">
<h2>Assignment</h2>
<div id="individual" class="section level3">
<h3>Individual</h3>
<p>Answer the following questions using <code>dplyr</code> and <code>tidyr</code> about GHG emissions since 1970…</p>
<pre class="r"><code>library(readxl)
url = &#39;http://edgar.jrc.ec.europa.eu/news_docs/CO2_1970-2014_dataset_of_CO2_report_2015.xls&#39;
xls = &#39;data/CO2_1970-2014_dataset_of_CO2_report_2015.xls&#39;

if (!file.exists(xls)){
  download.file(url, xls)
}
d = read_excel(xls, skip=12)</code></pre>
<p>sources: - <a href="http://edgar.jrc.ec.europa.eu/overview.php?v=CO2ts1990-2014&amp;sort=des9">CO2 time series per region/country | EUROPA</a> - <a href="https://en.wikipedia.org/wiki/List_of_countries_by_carbon_dioxide_emissions">List of countries by carbon dioxide emissions - Wikipedia, the free encyclopedia</a></p>
<ul>
<li><p>top 3 emitters in last year? compared to rest of world?</p></li>
<li><p>cumulative emissions?</p></li>
<li><p>per capita? join</p></li>
<li>join with population over time. get at emissions per capita</li>
<li>rank worst 10</li>
<li>get at cumulative emissions</li>
<li>join with GDP. fit model, who excessively bad/goodget?</li>
<li>references relevant to UCOP21:</li>
<li><a href="https://en.wikipedia.org/wiki/United_Nations_Framework_Convention_on_Climate_Change#Paris_Agreement">United Nations Framework Convention on Climate Change - Wikipedia, the free encyclopedia</a></li>
<li><a href="http://www.wri.org/blog/2014/11/6-graphs-explain-world%E2%80%99s-top-10-emitters">6 Graphs Explain the World’s Top 10 Emitters | World Resources Institute</a></li>
<li><a href="http://www3.epa.gov/climatechange/ghgemissions/global.html">Global Emissions | Climate Change | US EPA</a></li>
<li><p>just USA</p></li>
</ul>
</div>
<div id="group" class="section level3">
<h3>Group</h3>
</div>
</div>

  </div> <!--span-9-->
</div> <!--row-fluid-->

<!--
<script src="{{ site.baseurl }}/libs/lightbox-2.8.2/js/lightbox.min.js"></script>

<script>
    lightbox.option({
      'albumLabel': 'Example %1 of %2',
      'resizeDuration': 200,
      'fadeDuration': 200,
      'wrapAround': true
    })
</script>
-->

<style type="text/css">
.main-container {
  max-width: none;
}
</style>

<script>
$(function() {
    var toc = $("#toc").tocify({
      selectors: "h2,h3",
      theme: "bootstrap3",
      context: '.main-content',
      hashGenerator: 'pretty',
      showAndHide: false
    }).data("toc-tocify");
    $(".optionName").popover({ trigger: "hover" });
});
</script>

<div style="color:gray">
  <span class="octicon octicon-repo-forked"></span> <b>Fork</b> me at <a href="http://github.com/ucsb-bren/env-info">github.com/<b>ucsb-bren/env-info</b></a>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
