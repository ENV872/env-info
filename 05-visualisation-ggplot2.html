<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />



<title>Data visualisation with ggplot2</title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.1/css/readable.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.1/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/respond.min.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #303030; color: #cccccc; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; }
td.sourceCode { padding-left: 5px; }
pre, code { color: #cccccc; background-color: #303030; }
code > span.kw { color: #f0dfaf; }
code > span.dt { color: #dfdfbf; }
code > span.dv { color: #dcdccc; }
code > span.bn { color: #dca3a3; }
code > span.fl { color: #c0bed1; }
code > span.ch { color: #dca3a3; }
code > span.st { color: #cc9393; }
code > span.co { color: #7f9f7f; }
code > span.ot { color: #efef8f; }
code > span.al { color: #ffcfaf; }
code > span.fu { color: #efef8f; }
code > span.er { color: #c3bf9f; }
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css" />
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/octicons/3.3.0/octicons.css" type="text/css" />
<link rel="stylesheet" href="styles/styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>
<div class="container-fluid main-container">

<div class="navbar navbar-default navbar-fixed-top navbar-transparent">
  <div class="container">
    <div class="navbar-header">
      <!--<a href="./" class="navbar-brand"><img src="img/Bren-logo_height50.png">env-info</a>-->
      <a href="./" class="navbar-brand"><i class="fa fa-home"></i> env-info</a>
      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#navbar-main">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <div class="navbar-collapse collapse" id="navbar-main">
      <ul class="nav navbar-nav">
        <li>
          <a href="./schedule.html"><i class="fa fa-calendar"></i> schedule</a>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="./students.html"><i class="fa fa-users"></i> students</a></li>
      </ul>
    </div>
  </div>
</div>

<div id="header">
<h1 class="title">Data visualisation with ggplot2</h1>
<h3 class="subtitle"><em>Visualising data in R with ggplot2 package</em></h3>
</div>

<div id="TOC">
<ul>
<li><a href="#disclaimer">Disclaimer</a></li>
<li><a href="#data-cleaning-and-preparing-for-plotting">Data cleaning and preparing for plotting</a></li>
<li><a href="#plotting-with-ggplot2">Plotting with ggplot2</a></li>
<li><a href="#modifying-plots">Modifying plots</a></li>
<li><a href="#boxplot">Boxplot</a></li>
<li><a href="#plotting-time-series-data">Plotting time series data</a></li>
<li><a href="#faceting">Faceting</a></li>
</ul>
</div>

<p>Authors: <strong>Mateusz Kuzak</strong>, <strong>Diana Marek</strong>, <strong>Hedi Peterson</strong></p>
<div id="disclaimer" class="section level4">
<h4>Disclaimer</h4>
<p>We will here using functions of ggplot2 package. There are basic ploting capabilities in basic R, but ggplot2 adds more powerful plotting capabilities.</p>
<blockquote>
<h3>Learning Objectives</h3>
<ul>
<li>Visualise some of the <a href="http://figshare.com/articles/Portal_Project_Teaching_Database/1314459">mammals data</a> from Figshare <a href="http://files.figshare.com/1919744/surveys.csv">surveys.csv</a></li>
<li>Understand how to plot these data using R ggplot2 package. For more details on using ggplot2 see <a href="http://docs.ggplot2.org/current/">official documentation</a>.</li>
<li>Building step by step complex plots with ggplot2 package</li>
</ul>
</blockquote>
<p>Load required packages</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># plotting package</span>
<span class="kw">library</span>(ggplot2)
<span class="co"># piping / chaining</span>
<span class="kw">library</span>(magrittr)
<span class="co"># modern dataframe manipulations</span>
<span class="kw">library</span>(dplyr)</code></pre>
<p>Load data directly from figshare.</p>
<pre class="sourceCode r"><code class="sourceCode r">surveys_raw &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&quot;http://files.figshare.com/1919744/surveys.csv&quot;</span>)</code></pre>
<p><code>surveys.csv</code> data contains some measurements of the animals caught in plots.</p>
</div>
<div id="data-cleaning-and-preparing-for-plotting" class="section level2">
<h2>Data cleaning and preparing for plotting</h2>
<p>Let’s look at the summary</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(surveys_raw)</code></pre>
<p>There are few things we need to clean in the dataset.</p>
<p>There are missing values for species_id in some records. Let’s remove those.</p>
<pre class="sourceCode r"><code class="sourceCode r">surveys_complete &lt;-<span class="st"> </span>surveys_raw %&gt;%
<span class="st">                    </span><span class="kw">filter</span>(species_id !=<span class="st"> &quot;&quot;</span>)</code></pre>
<p>We saw in summary, there were NA’s in weight and hindfoot_length. Let’s remove rows with missing values in weight and hindfoot_length. In fact, let’s combine this with removing empty species_id, so we have one command and don’t make lots of intermediate variable names. This is where piping becomes really handy!</p>
<pre class="sourceCode r"><code class="sourceCode r">surveys_complete &lt;-<span class="st"> </span>surveys_raw %&gt;%
<span class="st">                    </span><span class="kw">filter</span>(species_id !=<span class="st"> &quot;&quot;</span>) %&gt;%<span class="st">        </span><span class="co"># remove missing species_id</span>
<span class="st">                    </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(weight)) %&gt;%<span class="st">          </span><span class="co"># remove missing weight</span>
<span class="st">                    </span><span class="kw">filter</span>(!<span class="kw">is.na</span>(hindfoot_length))     <span class="co"># remove missing hindfoot_length</span></code></pre>
<p>There are a lot of species with low counts, let’s remove the species with less than 10 counts.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># count records per species</span>
species_counts &lt;-<span class="st"> </span>surveys_complete %&gt;%
<span class="st">                  </span><span class="kw">group_by</span>(species_id) %&gt;%
<span class="st">                  </span>tally

<span class="kw">head</span>(species_counts)

<span class="co"># get names of those frequent species</span>
frequent_species &lt;-<span class="st"> </span>species_counts %&gt;%
<span class="st">                    </span><span class="kw">filter</span>(n &gt;=<span class="st"> </span><span class="dv">10</span>) %&gt;%
<span class="st">                    </span><span class="kw">select</span>(species_id)

surveys_complete &lt;-<span class="st"> </span>surveys_complete %&gt;%
<span class="st">           </span><span class="kw">filter</span>(species_id %in%<span class="st"> </span>frequent_species$species_id)</code></pre>
<p>Make simple scatter plot of <code>hindfoot_length</code> (in millimeters) as a function of <code>weight</code> (in grams), using basic R plotting capabilities.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="dt">x =</span> surveys_complete$weight, <span class="dt">y =</span> surveys_complete$hindfoot_length)</code></pre>
<p><img src="img/R-ecology-base-plot-1.png" title="" alt="" width="672" /></p>
</div>
<div id="plotting-with-ggplot2" class="section level2">
<h2>Plotting with ggplot2</h2>
<p>We will make the same plot using <code>ggplot2</code> package.</p>
<p><code>ggplot2</code> is a plotting package that makes it simple to create complex plots from data in a dataframe. It uses default settings, which help creating publication quality plots with minimal amount of settings and tweaking.</p>
<p>With ggplot graphics are build step by step by adding new elements.</p>
<p>To build a ggplot we need to:</p>
<ul>
<li>bind the plot to a specific data frame using the <code>data</code> argument</li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> surveys_complete)</code></pre>
<ul>
<li>define aesthetics (<code>aes</code>), that maps variables in the data to axes on the plot or to plotting size, shape color, etc.,</li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> surveys_complete, <span class="kw">aes</span>(<span class="dt">x =</span> weight, <span class="dt">y =</span> hindfoot_length))</code></pre>
<ul>
<li>add <code>geoms</code> – graphical representation of the data in the plot (points, lines, bars). To add a geom to the plot use <code>+</code> operator:</li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> surveys_complete, <span class="kw">aes</span>(<span class="dt">x =</span> weight, <span class="dt">y =</span> hindfoot_length)) +
<span class="st">  </span><span class="kw">geom_point</span>()</code></pre>
<p><img src="img/R-ecology-first-ggplot-1.png" title="" alt="" width="672" /></p>
<p>Notes:</p>
<ul>
<li>Anything you put in the <code>ggplot()</code> function can be seen by any geom layers that you add. i.e. these are universal plot settings</li>
<li>This includes the x and y axis you set up in <code>aes()</code></li>
</ul>
</div>
<div id="modifying-plots" class="section level2">
<h2>Modifying plots</h2>
<ul>
<li>adding transparency (alpha)</li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> surveys_complete, <span class="kw">aes</span>(<span class="dt">x =</span> weight, <span class="dt">y =</span> hindfoot_length)) +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.1</span>)</code></pre>
<p><img src="img/R-ecology-adding-transparency-1.png" title="" alt="" width="672" /></p>
<ul>
<li>adding colors</li>
</ul>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> surveys_complete, <span class="kw">aes</span>(<span class="dt">x =</span> weight, <span class="dt">y =</span> hindfoot_length)) +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.1</span>, <span class="dt">color =</span> <span class="st">&quot;blue&quot;</span>)</code></pre>
<p><img src="img/R-ecology-adding-colors-1.png" title="" alt="" width="672" /></p>
</div>
<div id="boxplot" class="section level2">
<h2>Boxplot</h2>
<p>Visualising the distribution of weight within each species.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> surveys_complete, <span class="kw">aes</span>(<span class="dt">x =</span> species_id,  <span class="dt">y =</span> weight)) +
<span class="st">                   </span><span class="kw">geom_boxplot</span>()</code></pre>
<p><img src="img/R-ecology-boxplot-1.png" title="" alt="" width="672" /></p>
<p>By adding points to boxplot, we can see particular measurements and the abundance of measurements.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> surveys_complete, <span class="kw">aes</span>(<span class="dt">x =</span> species_id, <span class="dt">y =</span> weight)) +
<span class="st">                   </span><span class="kw">geom_jitter</span>(<span class="dt">alpha =</span> <span class="fl">0.3</span>, <span class="dt">color =</span> <span class="st">&quot;tomato&quot;</span>) +
<span class="st">                   </span><span class="kw">geom_boxplot</span>(<span class="dt">alpha =</span> <span class="dv">0</span>)</code></pre>
<p><img src="img/R-ecology-boxplot-with-points-1.png" title="" alt="" width="672" /></p>
<p>Notice how the boxplot layer is on top of the jitter layer? Play around with the order of geoms and adjust transparency to see how to build up your plot in layers.</p>
<blockquote>
<h3>Challenge</h3>
<p>Create boxplot for <code>hindfoot_length</code>.</p>
</blockquote>
</div>
<div id="plotting-time-series-data" class="section level2">
<h2>Plotting time series data</h2>
<p>Let’s calculate number of counts per year for each species. To do that we need to group data first and count records within each group.</p>
<pre class="sourceCode r"><code class="sourceCode r">yearly_counts &lt;-<span class="st"> </span>surveys_complete %&gt;%
<span class="st">                 </span><span class="kw">group_by</span>(year, species_id) %&gt;%
<span class="st">                 </span>tally</code></pre>
<p>Timelapse data can be visualised as a line plot with years on x axis and counts on y axis.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> yearly_counts, <span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> n)) +
<span class="st">                  </span><span class="kw">geom_line</span>()</code></pre>
<p><img src="img/R-ecology-first-time-series-1.png" title="" alt="" width="672" /></p>
<p>Unfortunately this does not work, because we plot data for all the species together. We need to tell ggplot to split graphed data by <code>species_id</code></p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> yearly_counts, <span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> n, <span class="dt">group =</span> species_id)) +
<span class="st">  </span><span class="kw">geom_line</span>()</code></pre>
<p><img src="img/R-ecology-time-series-by-species-1.png" title="" alt="" width="672" /></p>
<p>We will be able to distinguish species in the plot if we add colors.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> yearly_counts, <span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> n, <span class="dt">group =</span> species_id, <span class="dt">color =</span> species_id)) +
<span class="st">  </span><span class="kw">geom_line</span>()</code></pre>
<p><img src="img/R-ecology-time-series-with-colors-1.png" title="" alt="" width="672" /></p>
</div>
<div id="faceting" class="section level2">
<h2>Faceting</h2>
<p>ggplot has a special technique called <em>faceting</em> that allows to split one plot into multiple plots based on some factor. We will use it to plot one time series for each species separately.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> yearly_counts, <span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> n, <span class="dt">color =</span> species_id)) +
<span class="st">  </span><span class="kw">geom_line</span>() +<span class="st"> </span><span class="kw">facet_wrap</span>(~species_id)</code></pre>
<p><img src="img/R-ecology-first-facet-1.png" title="" alt="" width="672" /></p>
<p>Now we would like to split line in each plot by sex of each individual measured. To do that we need to make counts in dataframe grouped by sex.</p>
<blockquote>
<h3>Challenges:</h3>
<ul>
<li>filter the dataframe so that we only keep records with sex “F” or “M”s</li>
</ul>
</blockquote>
<pre class="sourceCode r"><code class="sourceCode r">sex_values =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;F&quot;</span>, <span class="st">&quot;M&quot;</span>)
surveys_complete &lt;-<span class="st"> </span>surveys_complete %&gt;%
<span class="st">           </span><span class="kw">filter</span>(sex %in%<span class="st"> </span>sex_values)</code></pre>
<blockquote>
<ul>
<li>group by year, species_id, sex</li>
</ul>
</blockquote>
<pre class="sourceCode r"><code class="sourceCode r">yearly_sex_counts &lt;-<span class="st"> </span>surveys_complete %&gt;%
<span class="st">                     </span><span class="kw">group_by</span>(year, species_id, sex) %&gt;%
<span class="st">                     </span>tally</code></pre>
<blockquote>
<ul>
<li>make the faceted plot splitting further by sex (within single plot)</li>
</ul>
</blockquote>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> yearly_sex_counts, <span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> n, <span class="dt">color =</span> species_id, <span class="dt">group =</span> sex)) +
<span class="st">  </span><span class="kw">geom_line</span>() +<span class="st"> </span><span class="kw">facet_wrap</span>(~<span class="st"> </span>species_id)</code></pre>
<p><img src="img/R-ecology-facet-by-species-and-sex-1.png" title="" alt="" width="672" /></p>
<blockquote>
<p>We can improve the plot by coloring by sex instead of species (species are already in separate plots, so we don’t need to distinguish them better)</p>
</blockquote>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ggplot</span>(<span class="dt">data =</span> yearly_sex_counts, <span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> n, <span class="dt">color =</span> sex, <span class="dt">group =</span> sex)) +
<span class="st">  </span><span class="kw">geom_line</span>() +<span class="st"> </span><span class="kw">facet_wrap</span>(~<span class="st"> </span>species_id)</code></pre>
<p><img src="img/R-ecology-facet-by-species-and-sex-colored-1.png" title="" alt="" width="672" /></p>
</div>


</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
